<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SpanBuilder.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">client</a> &gt; <a href="index.source.html" class="el_package">org.honton.chas.datadog.apm</a> &gt; <span class="el_source">SpanBuilder.java</span></div><h1>SpanBuilder.java</h1><pre class="source lang-java linenums">package org.honton.chas.datadog.apm;

import java.io.PrintWriter;
import java.io.StringWriter;
import java.util.Collections;
import java.util.HashMap;
import java.util.Map;
import java.util.Random;
import java.util.concurrent.TimeUnit;

import org.honton.chas.datadog.apm.api.Span;

import lombok.Getter;
import lombok.RequiredArgsConstructor;
import lombok.Setter;
import lombok.experimental.Accessors;

/**
 * An active Span builder.  Provides methods to get and set the Span attributes.
 * Some attributes, such as the start time, traceId, parentId, and traceId
 * are final and cannot be modified.
 */
@Accessors(fluent = true)
@Getter
<span class="fc" id="L25">@Setter</span>
<span class="fc" id="L26">@RequiredArgsConstructor</span>
public class SpanBuilder {

<span class="fc" id="L29">  private static final Random ID_GENERATOR = new Random();</span>

<span class="fc" id="L31">  private final SpanBuilder parent;</span>

  /**
   * The resource name.
   */
<span class="fc" id="L36">  private String resource;</span>

  /**
   * The operation name.
   */
<span class="fc" id="L41">  private String operation;</span>

  /**
   * The id of the trace's root span.
   */
<span class="fc" id="L46">  private final long traceId;</span>

  /**
   * The id of the span's direct parent span.
   */
<span class="fc" id="L51">  private final Long parentId;</span>

  /**
   * The id of the span.
   */
<span class="fc" id="L56">  private final long spanId;</span>

  /** 
   * The type of the span. e.g. http, sql
   */
<span class="fc" id="L61">  private String type;</span>

  /**
   * The tags in the span.
   */
<span class="fc" id="L66">  private Map&lt;String, String&gt; meta;</span>

  /**
   * The metrics in the span.
   */
<span class="fc" id="L71">  private Map&lt;String, Number&gt; metrics;</span>

  /**
   * A error code that occurred for span
   */
<span class="fc" id="L76">  private int error;</span>

  /**
   * The span start in nanoseconds (not epoch time)
   */
<span class="pc" id="L81">  private final long start = System.nanoTime();</span>

<span class="fc" id="L83">  private static final long WALL_OFFSET = TimeUnit.MILLISECONDS.toNanos(System.currentTimeMillis()) - System.nanoTime();</span>

  /**
   * Add a metric.
   * 
   * @param key The name of the metric
   * @param value The value of the metric
   * 
   * @return The builder, for fluent style programming
   */
  public SpanBuilder metric(String key, Number value) {
<span class="fc bfc" id="L94" title="All 2 branches covered.">    if(metrics == null) {</span>
<span class="fc" id="L95">      metrics = new HashMap&lt;&gt;();</span>
    }
<span class="fc" id="L97">    metrics.put(key, value);</span>
<span class="fc" id="L98">    return this;</span>
  }

  /**
   * Add meta information.
   * 
   * @param key The name of the meta information
   * @param value The value of the meta information
   * 
   * @return The builder, for fluent style programming
   */
  public SpanBuilder meta(String key, String value) {
<span class="fc bfc" id="L110" title="All 2 branches covered.">    if(meta == null) {</span>
<span class="fc" id="L111">      meta = new HashMap&lt;&gt;();</span>
    }
<span class="fc" id="L113">    meta.put(key, value);</span>
<span class="fc" id="L114">    return this;</span>
  }

  /**
   * Add exception information to the metadata.  Any previous exception information will be overwritten.
   * 
   * @param e The exception to add
   * @return The builder, for fluent style programming
   */
  public SpanBuilder exception(Exception e) {
<span class="fc" id="L124">    meta(&quot;error.msg&quot;, e.getMessage());</span>
<span class="fc" id="L125">    String exception = e.getClass().getCanonicalName();</span>
<span class="fc" id="L126">    error = exception.hashCode();</span>
<span class="fc" id="L127">    meta.put(&quot;error.type&quot;, exception);</span>
<span class="fc" id="L128">    meta.put(&quot;error.stack&quot;, exceptionToString(e));</span>
<span class="fc" id="L129">    return this;</span>
  }

  /**
   * Create a child of this span
   * @return The child span
   */
  public SpanBuilder createChild() {
<span class="fc" id="L137">    return new SpanBuilder(this, traceId, spanId, createId());</span>
  }

  /**
   * Create a builder for a root span.
   * @return A builder for a root span
   */
  public static SpanBuilder createRoot() {
<span class="fc" id="L145">    long traceId = createId();</span>
<span class="fc" id="L146">    return new SpanBuilder(null, traceId, null, traceId);</span>
  }

  /**
   * Create a builder for a span which is a child of another span.
   * @param traceId The id of the trace
   * @param parentSpanId The id of the parent span
   * @return The span which is a child the the imported span.
   */
  public static SpanBuilder createChild(long traceId, long parentSpanId) {
<span class="fc" id="L156">    return new SpanBuilder(null, traceId, parentSpanId, createId());</span>
  }

  /**
   * Finish building the span.  Sets the duration of the span.
   * @param service The service value
   * @return The immutable Span that was completed
   */
  public Span finishSpan(String service) {
<span class="fc bfc" id="L165" title="All 2 branches covered.">    return new Span(service, resource, operation,</span>
        traceId, parentId, spanId, type,
<span class="fc bfc" id="L167" title="All 2 branches covered.">        meta != null ? copyOf(meta) : null,</span>
<span class="fc" id="L168">        metrics != null ? copyOf(metrics) : null,</span>
        error,
<span class="fc" id="L170">        WALL_OFFSET + start, System.nanoTime() - start);</span>
  }

  private static &lt;K,V&gt; Map&lt;K,V&gt; copyOf(Map&lt;K,V&gt; map) {
<span class="fc" id="L174">    return Collections.unmodifiableMap(new HashMap&lt;&gt;(map));</span>
  }

  /**
   * Create a 63 bit random id.  Top bit is always clear to prevent serializing negative id.
   * @return A positive long value.
   */
  private static long createId() {
<span class="fc" id="L182">    long high = ID_GENERATOR.nextInt() &amp; 0x7fffffffL;</span>
<span class="fc" id="L183">    long low = ID_GENERATOR.nextInt() &amp; 0xffffffffL;</span>
<span class="fc" id="L184">    return (high &lt;&lt; 32) | low;</span>
  }

  /**
   * Create a string representation of an exception stack trace.
   * @param ex The exceptions
   * @return The stack trace
   */
  private static String exceptionToString(Exception ex) {
<span class="fc" id="L193">    StringWriter errors = new StringWriter();</span>
<span class="fc" id="L194">    ex.printStackTrace(new PrintWriter(errors));</span>
<span class="fc" id="L195">    return errors.toString();</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>